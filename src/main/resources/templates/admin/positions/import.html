<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/admin-layout}"
>
  <head>
    <title layout:title-pattern="Import Positions - %s">Import Positions</title>
    <link th:href="@{/css/import.css}" rel="stylesheet" />
  </head>
  <body>
    <section layout:fragment="content">
      <div class="content-header">
        <h1>Import Positions</h1>
        <div class="header-actions">
          <a th:href="@{/admin/positions}" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Back to Positions
          </a>
        </div>
      </div>

      <div class="import-container">
        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          <span th:text="${successMessage}"></span>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger">
          <i class="fas fa-exclamation-triangle"></i>
          <span th:text="${errorMessage}"></span>
        </div>

        <div th:if="${importErrors}" class="alert alert-danger import-errors">
          <strong><i class="fas fa-exclamation-triangle"></i> Import Errors:</strong>
          <p th:if="${rolledBack}" class="rollback-notice">
            <i class="fas fa-undo"></i> All changes have been rolled back. No positions were imported.
          </p>
          <ul>
            <li th:each="error : ${importErrors}" th:text="${error}"></li>
          </ul>
        </div>

        <!-- Instructions -->
        <div class="import-card">
          <h3><i class="fas fa-info-circle"></i> Import Instructions</h3>
          <div class="instructions">
            <h4>CSV Format Requirements:</h4>
            <ul>
              <li>File must be in CSV format (.csv)</li>
              <li>
                Required columns: <code>Name</code>, <code>Abbreviation</code>
              </li>
              <li>Name must be unique and less than 255 characters</li>
              <li>Abbreviation must be unique and less than 50 characters</li>
              <li>Abbreviation will be converted to UPPERCASE automatically</li>
            </ul>
            <h4 style="margin-top: 16px;">Example:</h4>
            <table class="example-table" style="margin-top: 8px; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;">Name</th>
                  <th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5;">Abbreviation</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="border: 1px solid #ddd; padding: 8px;">Software Engineer</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">SE</td>
                </tr>
                <tr>
                  <td style="border: 1px solid #ddd; padding: 8px;">Project Manager</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">PM</td>
                </tr>
              </tbody>
            </table>
            <div style="margin-top: 16px">
              <a
                th:href="@{/admin/positions/import/template}"
                class="btn btn-outline"
              >
                <i class="fas fa-download"></i> Download Sample Template
              </a>
            </div>
          </div>
        </div>

        <!-- Upload Form -->
        <div class="import-card">
          <h3><i class="fas fa-upload"></i> Upload CSV File</h3>
          <form
            id="importForm"
            th:action="@{/admin/positions/import}"
            method="post"
            enctype="multipart/form-data"
          >
            <div
              class="file-upload-area"
              id="dropZone"
              onclick="document.getElementById('fileInput').click()"
            >
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Drag and drop your CSV file here, or click to browse</p>
              <p class="file-name" id="fileName"></p>
              <input
                type="file"
                id="fileInput"
                name="file"
                accept=".csv"
                style="display: none"
                onchange="handleFileSelect(this)"
              />
            </div>

            <div class="loading" id="loadingIndicator">
              <i class="fas fa-spinner"></i>
              <p>Processing file...</p>
            </div>

            <div class="btn-group">
              <button
                type="button"
                id="previewBtn"
                class="btn btn-secondary"
                disabled
              >
                <i class="fas fa-eye"></i> Preview
              </button>
              <button
                type="submit"
                id="importBtn"
                class="btn btn-primary"
                disabled
              >
                <i class="fas fa-file-import"></i> Import Positions
              </button>
            </div>
          </form>
        </div>

        <!-- Preview Section -->
        <div class="import-card hidden" id="previewSection">
          <h3><i class="fas fa-table"></i> Preview</h3>

          <div id="previewError" class="alert alert-danger hidden"></div>

          <div class="summary-box" id="summaryBox">
            <div class="summary-item total">
              <div class="number" id="totalCount">0</div>
              <div class="label">Total Rows</div>
            </div>
            <div class="summary-item valid">
              <div class="number" id="validCount">0</div>
              <div class="label">Valid</div>
            </div>
            <div class="summary-item invalid">
              <div class="number" id="invalidCount">0</div>
              <div class="label">Invalid</div>
            </div>
          </div>

          <div style="overflow-x: auto">
            <table class="preview-table" id="previewTable">
              <thead>
                <tr id="previewHeaders"></tr>
              </thead>
              <tbody id="previewBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <script th:inline="javascript">
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const fileName = document.getElementById("fileName");
        const previewBtn = document.getElementById("previewBtn");
        const importBtn = document.getElementById("importBtn");
        const previewSection = document.getElementById("previewSection");
        const loadingIndicator = document.getElementById("loadingIndicator");

        // Drag and drop
        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("dragover");
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("dragover");

          const files = e.dataTransfer.files;
          if (files.length > 0 && files[0].name.endsWith(".csv")) {
            fileInput.files = files;
            handleFileSelect(fileInput);
          }
        });

        function handleFileSelect(input) {
          const file = input.files[0];
          if (file) {
            fileName.textContent = file.name;
            previewBtn.disabled = false;
            importBtn.disabled = false;
            previewSection.classList.add("hidden");
          }
        }

        // Preview
        previewBtn.addEventListener("click", async () => {
          const file = fileInput.files[0];
          if (!file) return;

          loadingIndicator.classList.add("show");
          previewSection.classList.add("hidden");

          const formData = new FormData();
          formData.append("file", file);

          try {
            const response = await fetch(
              /*[[@{/admin/positions/import/preview}]]*/ "/admin/positions/import/preview",
              {
                method: "POST",
                body: formData,
              }
            );

            // Check if response is OK
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            displayPreview(result);
          } catch (error) {
            console.error("Preview error:", error);
            previewSection.classList.remove("hidden");
            const previewError = document.getElementById("previewError");
            if (previewError) {
              previewError.textContent = "Error previewing file: " + error.message;
              previewError.classList.remove("hidden");
            }
          } finally {
            loadingIndicator.classList.remove("show");
          }
        });

        function displayPreview(result) {
          
          // Show preview section first so elements are accessible
          previewSection.classList.remove("hidden");
          
          const previewError = document.getElementById("previewError");
          const summaryBox = document.getElementById("summaryBox");
          const previewHeaders = document.getElementById("previewHeaders");
          const previewBody = document.getElementById("previewBody");

          // Reset
          if (previewError) previewError.classList.add("hidden");
          if (previewHeaders) previewHeaders.innerHTML = "";
          if (previewBody) previewBody.innerHTML = "";

          // Check for file error
          if (result.fileError) {
            if (previewError) {
              previewError.textContent = result.fileError;
              previewError.classList.remove("hidden");
            }
            if (summaryBox) summaryBox.style.display = "none";
            return;
          }

          if (summaryBox) summaryBox.style.display = "flex";

          // Update summary
          document.getElementById("totalCount").textContent =
            result.totalRows || 0;
          document.getElementById("validCount").textContent =
            result.validRows || 0;
          document.getElementById("invalidCount").textContent =
            result.invalidRows || 0;

          // Create headers
          if (result.headers && result.headers.length > 0 && previewHeaders) {
            previewHeaders.innerHTML =
              "<th>#</th>" +
              result.headers.map((h) => `<th>${h}</th>`).join("") +
              "<th>Status</th>";
          }

          // Create rows
          if (result.rows && result.rows.length > 0 && previewBody) {
            result.rows.forEach((row) => {
              const tr = document.createElement("tr");
              tr.className = row.valid ? "valid" : "invalid";

              let html = `<td>${row.rowNumber}</td>`;
              if (row.data) {
                html += row.data.map((d) => `<td>${d || ""}</td>`).join("");
              }

              if (row.valid) {
                html += '<td><span class="badge badge-success">Valid</span></td>';
              } else {
                html += `<td>
                              <span class="badge badge-danger">Invalid</span>
                              <ul class="error-list">
                                  ${(row.errors || []).map((e) => `<li>${e}</li>`).join("")}
                              </ul>
                          </td>`;
              }

              tr.innerHTML = html;
              previewBody.appendChild(tr);
            });
          } else {
            previewBody.innerHTML = '<tr><td colspan="100" style="text-align: center;">No data rows found</td></tr>';
          }
        }
      </script>
    </section>
  </body>
</html>
